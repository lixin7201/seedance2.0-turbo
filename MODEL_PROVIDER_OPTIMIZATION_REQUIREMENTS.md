# 模型-平台切换优化：需求文档

## 0. 背景
当前产品定位：前端用户只选择“模型”，管理员可在后台随时切换“模型对应的平台 API”，以灵活控制成本。  
已实现功能必须保持不变，不影响现有用户流程和数据。

## 1. 目标
1. 后端可自由切换“模型 → 平台”的映射，不改前端使用方式。
2. 切换平台后**不影响已有任务的查询/回调**。
3. 新增模型时，管理员可配置平台映射，并可用 Postman 自检。
4. 发生报错时，管理员可通过文档模板+示例提交给 AI 自动排错。
5. 当某个平台响应慢或不稳定时，管理员切换到更稳定的平台，用户端应无感切换且不报错。
6. 后台只展示“已调通/验证通过”的模型；未调通模型在后台不可见，但保留文件与配置以便后续启用。

## 2. 非目标（明确不做）
1. 不改变已有前端页面/交互逻辑（用户仍只选模型）。
2. 不重写平台 provider 逻辑（fal/replicate/kie/evolink 等现有适配不动）。
3. 不改变现有业务数据结构的含义（历史任务仍可查询）。

## 3. 现状痛点
1. 后台切平台只改 `currentProvider`，**没有对应的平台模型 ID**配置入口。  
   结果：切换后调用错误的模型 ID，必然失败。
2. 任务查询阶段用“当前配置”重新解析模型 ID。  
   结果：任务生成后若切平台，会导致查询错模型。
3. 平台参数格式差异大，切平台后容易参数不兼容。
4. image/music 还未使用统一模型配置体系。

## 4. 需求范围
### 4.1 数据层
需支持“同一模型在不同平台的模型 ID 映射”，且可随时切换当前平台。

**必须满足：**
- 同一模型可配置多平台映射。
- 切平台不需要修改“模型 ID 映射”本身。
- 支持平台级启用/禁用。

**方案选型（任选其一，需确认）：**
1. 方案 A：新增 `ai_model_provider` 表  
   字段示例：`modelId` / `provider` / `providerModelId` / `enabled` / `params` / `updatedAt`
2. 方案 B：在 `ai_model_config` 新增 JSON 字段 `providerModelMap`  
   格式示例：`{ "fal": "...", "evolink": "..." }`

### 4.2 任务快照
生成任务时应保存“实际使用的平台模型 ID”，查询时优先使用该快照。

**必须满足：**
- 生成任务时记录 `providerModelIdSnapshot`（字段名可自定）。
- 查询任务时优先使用快照；若无快照，才回退用当前配置。

### 4.3 管理后台能力
后台必须能完整管理“模型 ↔ 平台”映射。

**必须满足：**
- 可编辑 `providerModelId`（不只切 provider）。
- 切换 `currentProvider` 时必须校验：
  - 该平台是否配置 API Key
  - 该模型在该平台是否有映射
- 可启用/禁用指定平台映射。
- 支持“模型验证状态”（已调通 / 未调通），后台只展示已调通模型。

### 4.4 API 行为（不改前端调用方式）
前端继续只传 `model`。后端应：
1. 读取当前模型配置。
2. 选择 `currentProvider`。
3. 找到对应平台的 `providerModelId`。
4. 生成任务时写入快照。
5. 查询任务时优先读取快照。
6. 切换平台后，新任务立刻使用新平台，旧任务仍按快照查询。

### 4.5 名称归一化（必须实现）
不同平台同一模型名称可能不一致，必须归一化到“统一模型 ID”。

**必须满足：**
1. 每个模型有唯一“统一模型 ID”。
2. 平台名称必须映射到统一模型 ID（例如 `seedance-1.5-pro` / `seedance 1.5 pro` / `seedance1.5`）。
3. 归一化规则必须可配置、可扩展，不能硬编码在前端。
4. 当管理员提交新平台示例（Postman）时，系统能按规则自动归类到统一模型。

---

## 5. 兼容性要求
1. 旧数据仍可正常查询。
2. 无快照字段的历史任务要能回退使用当前配置。
3. 未配置多平台映射的模型仍按旧逻辑工作。
4. 未调通模型仅隐藏不删除，后续可直接启用。

---

## 6. 运维与文档要求
1. 新增模型必须能通过 Postman 自检。
2. 必须提供标准模板收集平台请求/响应示例与官方链接。  
   模板已在 `AI_PROVIDER_PLAYBOOK.md`。

---

## 7. 验收标准（可操作）
1. 切换模型平台后，生成任务成功率不下降。
2. 切换平台不会影响已有任务的查询结果。
3. 后台可配置模型在多个平台的映射。
4. 管理员可用 Postman 按模板调通一个新模型。
5. 不同平台名称能自动归一化到统一模型 ID。
6. 未调通模型（如 veo、sora）在后台不可见，但可随时启用。

---

## 8. 风险与注意事项
1. 平台参数格式不兼容仍可能失败，需要在平台侧文档对齐。
2. 不同平台的模型能力差异可能导致输出质量变化，需前期测试。

---

## 9. 文件修改清单（明确且不可歧义）
以下为**唯一允许修改/新增**的文件范围；未列出的文件与功能必须保持不变。

### 9.1 数据与模型层
- `src/config/db/schema.postgres.ts`  
  - 变更：为 `ai_model_config` 增加“多平台映射字段”或新增 `ai_model_provider` 表（二选一）。  
  - 变更：为 `ai_task` 增加 `providerModelIdSnapshot`（或等效字段）。  
  - 变更：增加“已调通/验证通过”状态字段（例如 `verified` / `is_ready`）。
- `src/config/db/schema.mysql.ts`  
  - 同上，保持三种数据库 schema 一致。
- `src/config/db/schema.sqlite.ts`  
  - 同上，保持三种数据库 schema 一致。
- `src/config/db/migrations/*`  
  - 新增迁移文件：创建/修改表结构以支持多平台映射、快照字段、验证状态。
- `src/shared/models/ai_model_config.ts`  
  - 变更：解析并返回多平台映射字段。  
  - 变更：查询接口支持“只返回已调通模型”给前台列表。  
  - 变更：提供按 `currentProvider` 选择平台模型 ID 的工具方法。
- `src/shared/models/ai_task.ts`  
  - 变更：写入/读取 `providerModelIdSnapshot` 字段。  
  - 变更：保持历史任务兼容（无快照时回退旧逻辑）。

### 9.2 API 层
- `src/app/api/models/route.ts`  
  - 变更：仅返回“已调通/验证通过”的模型给前端。
- `src/app/api/admin/model-config/route.ts`  
  - 变更：支持更新多平台映射字段。  
  - 变更：支持更新“已调通/验证状态”。  
  - 变更：切换 `currentProvider` 时校验映射与 API Key。
- `src/app/api/ai/generate/route.ts`  
  - 变更：按 `currentProvider` 取平台模型 ID。  
  - 变更：写入 `providerModelIdSnapshot` 到任务。
- `src/app/api/ai/query/route.ts`  
  - 变更：优先用 `providerModelIdSnapshot` 查询；无快照再回退当前映射。

### 9.3 管理后台
- `src/app/[locale]/(admin)/admin/model-config/page.tsx`  
  - 变更：可编辑平台模型名（不只切换 provider）。  
  - 变更：显示并可设置“已调通/未调通”。  
  - 变更：未调通模型在后台默认不可见（可切换筛选显示）。

### 9.4 初始化脚本（可选但推荐）
- `scripts/seed-ai-models.ts`  
  - 变更：初始数据需标记“已调通/未调通”。  
  - 变更：若采用多平台映射结构，需填入映射示例。

### 9.5 文档（不可影响业务）
- `AI_PROVIDER_PLAYBOOK.md`  
  - 仅用于整理平台 API 示例与模型归一化规则，不影响代码逻辑。

---

## 10. 禁止修改清单（明确不动）
以下功能与文件不得改动（除非新增字段强制要求的类型更新）：
1. 前端用户侧页面交互与路由（用户仍只选模型）。
2. 已有平台 provider 逻辑（`src/extensions/ai/*`）。
3. 支付、订阅、登录、活动记录等非模型相关功能与文件。
